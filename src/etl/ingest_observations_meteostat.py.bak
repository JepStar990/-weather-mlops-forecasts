"""
Meteostat hourly observations for the nearest station to each configured location.
Docs: https://pypi.org/project/meteostat/
"""

import pandas as pd
from datetime import datetime, timedelta, timezone
from meteostat import Point, Hourly, Stations

from src.config import CFG
from src.utils.db_utils import insert_dataframe
from src.utils.logging_utils import get_logger
from src.utils.unit_utils import normalize_value

logger = get_logger(__name__)


def nearest_station(lat: float, lon: float):
    """
    Return the nearest station id & coords (if any).
    NOTE: We do NOT call .inventory(hours=True) because that arg is not supported
    on your installed meteostat version. Weâ€™ll rely on Hourly(Point(...)) fetch.
    """
    try:
        # Fetch 1 nearest station
        station_df = Stations().nearby(lat, lon).fetch(1)
    except Exception as e:
        logger.warning("Stations lookup failed near %.3f,%.3f: %s", lat, lon, e)
        return None, None

    if station_df.empty:
        return None, None

    row = station_df.iloc[0]
    return row.get("id"), (float(row.get("latitude")), float(row.get("longitude")))


def fetch_obs(lat: float, lon: float) -> pd.DataFrame:
    """
    Fetch the last 7 days of hourly observations (UTC) near the given lat/lon.
    Uses meteostat's Point-based query which aggregates data from the nearest station(s).
    """
    station_id, _ = nearest_station(lat, lon)
    if not station_id:
        logger.warning("No station found near %.3f,%.3f", lat, lon)
        return pd.DataFrame()

    end = datetime.now(timezone.utc).replace(minute=0, second=0, microsecond=0)
    start = end - timedelta(days=7)

    # Point-based hourly fetch; meteostat will select appropriate station/time series
    p = Point(lat, lon)
    try:
        df = Hourly(p, start, end, timezone="UTC").fetch()
    except Exception as e:
        logger.warning("Hourly fetch failed near %.3f,%.3f: %s", lat, lon, e)
        return pd.DataFrame()

    if df is None or df.empty:
        logger.info("No hourly observations returned near %.3f,%.3f in the last 7 days", lat, lon)
        return pd.DataFrame()

    rows = []
    for ts, row in df.iterrows():
        obs_time = ts.to_pydatetime().replace(tzinfo=timezone.utc)

        # Temperature
        if "temp_2m" in CFG.VARIABLES and "temp" in row and pd.notna(row["temp"]):
            v, u = normalize_value("temp_2m", float(row["temp"]), "C")
            rows.append({
                "station_id": station_id,
                "lat": lat, "lon": lon,
                "variable": "temp_2m",
                "obs_time": obs_time,
                "value": v, "unit": u,
                "source": "meteostat",
            })

        # Wind speed (meteostat hourly often provides 'wspd' in km/h)
        if "wind_speed_10m" in CFG.VARIABLES and "wspd" in row and pd.notna(row["wspd"]):
            v, u = normalize_value("wind_speed_10m", float(row["wspd"]), "km/h")
            rows.append({
                "station_id": station_id,
                "lat": lat, "lon": lon,
                "variable": "wind_speed_10m",
                "obs_time": obs_time,
                "value": v, "unit": u,
                "source": "meteostat",
            })

        # Precipitation (mm)
        if "precipitation" in CFG.VARIABLES and "prcp" in row and pd.notna(row["prcp"]):
            v, u = normalize_value("precipitation", float(row["prcp"] or 0.0), "mm")
            rows.append({
                "station_id": station_id,
                "lat": lat, "lon": lon,
                "variable": "precipitation",
                "obs_time": obs_time,
                "value": v, "unit": u,
                "source": "meteostat",
            })

    return pd.DataFrame(rows)


def main():
    frames = []
    for loc in CFG.TARGET_LOCATIONS:
        logger.info("Meteostat observations: %s", loc["name"])
        frames.append(fetch_obs(loc["lat"], loc["lon"]))

    df = pd.concat(frames, ignore_index=True) if frames else pd.DataFrame()
    inserted = insert_dataframe(df, "observations")
    logger.info("Inserted %d observation rows", inserted)


if __name__ == "__main__":
    main()
